# Story Regression Lock — Proof Artifacts

**Date**: 2026-02-25
**Device**: Mike V. iPhone (00008120-001C31990198201E) — iPhone 14 Pro, iOS 26.0.1
**Method**: Physical device via mobile-mcp (WebDriverAgent)
**Build**: Dev client (NO OTA)

---

## Test Results

### Suite A: Hub Flow

| Test | Description                                           | Result  |
| ---- | ----------------------------------------------------- | ------- |
| A1   | Tap "Your Story" → hub opens                          | ✅ PASS |
| A2   | Gallery/Camera/Text/Mention buttons visible           | ✅ PASS |
| A3   | Share button grayed (no media)                        | ✅ PASS |
| A4   | "Friends" / "Close Friends" visibility toggle present | ✅ PASS |

### Suite B: Image Flow

| Test | Description                                                      | Result  |
| ---- | ---------------------------------------------------------------- | ------- |
| B1   | Gallery tap → system photo picker opens ("Select up to 4 items") | ✅ PASS |
| B2   | Cancel from picker → returns cleanly (no crash, no ghost state)  | ✅ PASS |
| B3   | Select image → Crop screen opens                                 | ✅ PASS |
| B4   | Crop Done → hub loads image with creative tools visible          | ✅ PASS |

### Suite D: Text-Only Flow

| Test | Description                                                                 | Result  |
| ---- | --------------------------------------------------------------------------- | ------- |
| D1   | Text button → text editor opens (keyboard + "Type something..." + controls) | ✅ PASS |
| D2   | Cancel text input → editor idle mode (background picker visible)            | ✅ PASS |
| D3   | Close editor (X) → back to hub, no ghost mode                               | ✅ PASS |

### Suite E: Re-entry + Repeatability (3x)

| Cycle | Editor Opens Clean     | Hub Clean After Cancel | Ghost Mode |
| ----- | ---------------------- | ---------------------- | ---------- |
| 1     | ✅ "Type something..." | ✅ "New Story" hub     | ✅ None    |
| 2     | ✅ "Type something..." | ✅ "New Story" hub     | ✅ None    |
| 3     | ✅ "Type something..." | ✅ "New Story" hub     | ✅ None    |

---

## Invariants Verified

| Invariant                                         | Status      | Evidence                                                         |
| ------------------------------------------------- | ----------- | ---------------------------------------------------------------- |
| INV-NAV-1: Cancel ALWAYS returns to HUB           | ✅ Verified | All cancel paths returned to "New Story" hub                     |
| INV-NAV-6: No ghost mode after cancel             | ✅ Verified | Text editor never appeared after canceling; hub clean every time |
| INV-RENDER-1: No layout shift on editor mount     | ✅ Verified | Text editor rendered immediately with keyboard + controls        |
| INV-RENDER-2: Tool panels use conditional render  | ✅ Verified | Background picker only visible in idle w/o media                 |
| INV-STATE-5: resetEditor returns to initial state | ✅ Verified | 3x rapid cycles showed no stale content                          |

---

## Code Changes (4 files, 1 new store)

### Fix 1: Editor Reset Race Condition (RISK-1)

**File**: `app/(protected)/story/editor.tsx`

- **Before**: 200ms deferred `Debouncer` reset on close — stale state window
- **After**: Synchronous `resetEditor()` BEFORE `router.back()` on cancel; reset-on-mount guard; `[STOP-THE-LINE]` dev assertion; `StoryFlowStore.transitionTo("HUB")` on close/save

### Fix 2: initialMode Delay (RISK-2)

**File**: `src/stories-editor/screens/EditorScreen.tsx`

- **Before**: 350ms `Debouncer` delay before `initialMode` applied
- **After**: `requestAnimationFrame` — mode set on first painted frame

### Fix 3: Stop-the-Line Assertions (RISK-4)

**File**: `src/stories-editor/stores/editor-store.ts`

- **Before**: `resetEditor()` was a silent `set()` call
- **After**: Validates 5 fields (mode, elements, drawingPaths, selectedElementId, mediaUri) in `__DEV__`

### Fix 4: Formal State Machine (RISK-3)

**New file**: `lib/stores/story-flow-store.ts`

- `StoryFlowState` enum: IDLE → HUB → PICKER_IMAGE/VIDEO, EDIT_IMAGE/VIDEO, TEXT_ONLY, SHARING
- `transitionTo()` with valid-transition map — logs `[STOP-THE-LINE]` on invalid transition
- Session ID tracking for cross-session leak detection
- Wired into `create.tsx` (hub) and `editor.tsx` (editor route)

**File**: `app/(protected)/story/create.tsx`

- `transitionTo("TEXT_ONLY")` before text editor navigation
- `transitionTo("EDIT_IMAGE"/"EDIT_VIDEO")` before Skia editor navigation
- `forceIdle()` on hub close/discard

---

## Regression Risk Assessment

| Risk                                                      | Severity | Guard                                                     |
| --------------------------------------------------------- | -------- | --------------------------------------------------------- |
| Save path uses 300ms deferred reset (hub needs editedUri) | Low      | Reset-on-mount guard catches stale state on next entry    |
| Video editor flow not yet tested on device                | Medium   | Same state machine + reset path as image; needs follow-up |
| Skia canvas remount during rapid mode switching           | Low      | `setMode()` only updates store, no unmount                |
| New tool panels added without conditional render          | Medium   | INV-RENDER-2 in REGRESSION_LOCK.md; code review gate      |

---

## Summary

- **14 tests executed on physical device** (iPhone 14 Pro, iOS 26.0.1)
- **14 passed, 0 failed, 0 stop-the-line violations**
- **3x repeatability proven** — no state degradation across rapid cycles
- **Zero ghost mode occurrences**
- **4 risks fixed** — all identified in REGRESSION_LOCK.md
- **1 new store** — `StoryFlowState` deterministic state machine
- **0 TypeScript errors** after all changes
