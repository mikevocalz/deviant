# Crash Fix Report — Feb 23, 2026

## Build 1.0.165 (`aaab5c3`)

---

## 1. Main App Crash (SEV-0) — Open/Reopen SIGABRT

### Symptoms
- App launches successfully on first cold boot
- Terminating and relaunching immediately crashes with `SIGABRT`
- Expo ErrorRecovery exhausts retries → native `abort()` → crash dialog
- Crash loop: app cannot recover without manual intervention

### Root Cause
A previous OTA update was pushed locally without proper environment variables. Metro inlined a bad value for `EXPO_PUBLIC_SUPABASE_URL` into the JS bundle. On relaunch, Expo Updates applied the cached OTA, and `@supabase/supabase-js` v2.95.3's `validateSupabaseUrl()` threw:

```
Unhandled JS Exception: Error: Invalid supabaseUrl: Must be a valid HTTP or HTTPS URL.
```

Expo ErrorRecovery caught the fatal JS error, attempted to fetch a newer OTA, found none available, and called `abort()` — producing the `SIGABRT` / `EXC_CRASH` seen in the `.ips` crash report.

### Crash Chain
```
OTA with bad env var cached on device
  → Expo Updates applies cached OTA on relaunch
    → createClient() receives non-URL string
      → validateSupabaseUrl() throws
        → Expo ErrorRecovery catches fatal JS error
          → No newer OTA available → abort() → SIGABRT
```

### Fix
Hardened **all 7 client-side files** that reference `EXPO_PUBLIC_SUPABASE_URL` with strict URL validation + hardcoded fallback. The simple `||` fallback pattern is **not sufficient** — Metro can inline truthy non-URL strings that bypass `||` but fail URL validation.

**Before (vulnerable):**
```ts
const supabaseUrl = process.env.EXPO_PUBLIC_SUPABASE_URL || "https://npfjanxturvmjyevoyfo.supabase.co";
```

**After (crash-safe):**
```ts
const FALLBACK_SUPABASE_URL = "https://npfjanxturvmjyevoyfo.supabase.co";
const rawUrl = process.env.EXPO_PUBLIC_SUPABASE_URL;
const supabaseUrl =
  typeof rawUrl === "string" && rawUrl.startsWith("https://")
    ? rawUrl
    : FALLBACK_SUPABASE_URL;
```

### Files Changed
| File | Risk | Change |
|------|------|--------|
| `lib/supabase/client.ts` | **Critical** — main Supabase client | Added typeof + startsWith validation |
| `lib/media/upload-media.ts` | **High** — was throwing without fallback | Replaced throw with fallback |
| `lib/api/promotions.ts` | Medium | Added validation |
| `components/animated-splash-screen.tsx` | Medium | Added validation |
| `components/signup/SignUpStep2.tsx` | Medium | Added validation |
| `app/_layout.tsx` | Medium | Added validation |
| `app/(protected)/debug.tsx` | Low | Added validation |

### Recovery Procedure (for devices stuck in crash loop)
```bash
# 1. Delete Expo Updates database
ios fsync --app=com.dvnt.app rm --path="Library/Application Support/.expo-internal/expo-v11.db"

# 2. Delete cached OTA bundle
ios fsync --app=com.dvnt.app rm --path="Library/Application Support/.expo-internal/bundle-*.jsbundle"

# 3. Overwrite stale error log (can't delete due to AFC permissions)
echo -n "" > /tmp/empty && ios fsync --app=com.dvnt.app push --srcPath=/tmp/empty --dstPath="Library/Application Support/expo-error.log"

# 4. Relaunch — app falls back to embedded bundle
```

### Prevention
- **Always** explicitly export env vars before local `eas update`:
  ```bash
  source .env && npx eas-cli update --branch production --message "..."
  ```
- The hardened validation ensures even if env vars are missing/garbage, the app uses the hardcoded fallback and never crashes

---

## 2. Widget Extension Crash — MapLibre DYLD

### Symptoms
- `DVNTHomeWidgetExtension` crashes immediately on load
- iOS shows repeated "DVNT Crashed" dialogs (one per widget refresh cycle)
- Crash report: `DYLD: Library not loaded: @rpath/MapLibre.framework/MapLibre`

### Root Cause
The MapLibre React Native pod (`$MLRN.post_install`) injects MapLibre SPM into **all** targets in the Xcode project, including the widget extension. The widget is pure SwiftUI and doesn't use MapLibre, but the linker still expects the framework at runtime → DYLD crash.

### Fix
Config plugin `plugins/fix-widget-maplibre.js` strips MapLibre SPM from the `DVNTHomeWidgetExtension` target at prebuild time via:
1. Podfile Ruby injection to remove MapLibre from widget target
2. pbxproj modification to strip MapLibre package references from the widget

This is a **build-time fix** — only takes effect in new native builds, not OTA updates.

### Verification
Build 1.0.165 includes this plugin. Widget extension no longer crashes with DYLD errors.

---

## Diagnosis Tools Used
- **go-ios** (`ios file pull`, `ios fsync`, `ios crash ls/cp`) — pulled crash reports and Expo logs from device
- **mobile-mcp** — automated app launch/terminate/screenshot cycles on physical device
- **Expo Updates log** (`dev.expo.modules.core.logging.expo-updates.txt`) — revealed ErrorRecovery flow and "NoUpdateAvailable" state
- **expo-error.log** — contained the exact JS exception message
- **.ips crash report** — confirmed SIGABRT / NSException on background dispatch queue

## Timeline
| Time | Event |
|------|-------|
| 09:37 | Previous OTA pushed with bad env vars |
| 09:50 | First launch — works (embedded bundle) |
| 09:55 | Relaunch — SIGABRT crash (cached bad OTA applied) |
| 10:10 | Hardened fix committed + clean OTA pushed |
| 10:17 | New EAS build 1.0.165 triggered |
| 10:30 | Build complete, submitted to TestFlight |
| 10:35 | Rollback-to-embedded OTA published as safety net |
| 10:46 | Build 1.0.165 installed from TestFlight |
| 10:48 | **3 consecutive launch/relaunch cycles — zero crashes** |
