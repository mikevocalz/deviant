# DVNT Live Surface Architecture

## Overview

Cross-platform "live" experience:
- **iOS**: ActivityKit Live Activities + Dynamic Island (compact/minimal/expanded) + Lock Screen UI
- **Android**: Ongoing notification with RemoteViews + 6 independent PendingIntents
- **Both**: Universal links routing into the RN app

## 3-Tile Carousel

### Tile 1 — Upcoming Event (or fallback)
- Nearest upcoming event, or most recent if none upcoming
- Fallback: "Create your first event" CTA → `/events/create`
- Deep link: `/e/{eventId}`

### Tile 2 — Past Week "Top Moments" Grid (2×3) — **6 LINKS**
- 6 most-liked posts from last 7 days
- Each cell is an independent deep link → `/p/{postId}`
- Padded to exactly 6 items server-side (placeholders → `/recap/week`)

### Tile 3 — Top 3 Events Soon
- Up to 3 upcoming events
- Each card → `/e/{eventId}`
- "See all" → `/events?sort=soon`

## File Structure

```
src/live-surface/
  types.ts                          # LiveSurfacePayload type contract
  index.ts                          # Barrel export
  api.ts                            # Edge function client
  store.ts                          # Zustand store
  hooks/
    use-live-surface.ts             # Main integration hook (mounted in protected layout)
  native/
    ios-bridge.ts                   # NativeModules bridge → DVNTLiveActivity
    android-bridge.ts               # NativeModules bridge → DVNTLiveNotification

supabase/functions/live-surface/    # Edge function (Deno)
  index.ts                          # Builds all 3 tiles in parallel, caches 5min

supabase/migrations/
  20260220_kv_cache_and_live_surface.sql  # kv_cache table for payload caching

plugins/
  with-live-activity.js             # Config plugin (iOS Widget Extension + Android notification)

lib/deep-linking/
  route-registry.ts                 # Added: /events/create, /recap/week, /moment/:id

public/.well-known/
  apple-app-site-association        # Added: /recap/*, /moment/*
```

## Data Contract

```typescript
type LiveSurfacePayload = {
  generatedAt: string;              // ISO timestamp
  tile1: {
    eventId: string | null;
    title: string;
    startAt: string | null;         // ISO date
    venueName?: string;
    city?: string;
    heroThumbUrl?: string | null;   // CDN thumb only
    isUpcoming: boolean;
    deepLink: string;
  };
  tile2: {
    weekStartISO: string;           // YYYY-MM-DD
    items: Array<{
      id: string;
      thumbUrl: string | null;
      deepLink: string;
      a11yLabel?: string;
    }>;                             // Always length 6 (padded server-side)
    recapDeepLink: string;
  };
  tile3: {
    items: Array<{
      eventId: string;
      title: string;
      startAt: string;
      venueName?: string;
      city?: string;
      heroThumbUrl?: string | null;
      deepLink: string;
    }>;                             // Up to 3
    seeAllDeepLink: string;
  };
  weather?: {
    icon: "sun"|"cloud"|"rain"|"snow"|"storm"|"fog"|"wind";
    tempF?: number;
    label?: string;
  };
};
```

## Deep Link Routes

| URL Path | Expo Router Path | Purpose |
|---|---|---|
| `/e/:id` | `/(protected)/events/:id` | Event detail (existing) |
| `/p/:id` | `/(protected)/post/:id` | Post/Moment detail (existing) |
| `/events/create` | `/(protected)/events/create` | Create event (NEW) |
| `/recap/week` | `/(protected)/(tabs)/events` | Weekly recap (NEW) |
| `/moment/:id` | `/(protected)/post/:id` | Moment alias (NEW) |
| `/events?sort=soon` | `/(protected)/(tabs)/events` | Events sorted soonest (existing) |

Base domain: `https://dvntlive.app`

## iOS Architecture

### Widget Extension (`DVNTLiveActivityExtension`)
- **Target**: Separate Xcode target added by `with-live-activity.js` config plugin
- **Bundle ID**: `com.dvnt.app.live-activity`
- **Deployment Target**: iOS 16.4
- **App Group**: `group.com.dvnt.app` (shared UserDefaults for data passing)

### Files Generated by Config Plugin
- `DVNTLiveAttributes.swift` — ActivityAttributes + ContentState (shared between main app and extension)
- `DVNTLiveActivityWidget.swift` — SwiftUI views for Lock Screen + Dynamic Island
- `DVNTWidgetBundle.swift` — Widget bundle entry point
- `DVNTLiveActivityModule.swift` — Native module bridge (main app target)
- `DVNTLiveActivityBridge.m` — ObjC bridge to expose Swift module to RN

### Dynamic Island Modes
- **Compact Leading**: DVNT logo (16×16)
- **Compact Trailing**: Countdown ("in 3h 12m") or temperature
- **Minimal**: DVNT logo glyph (14×14)
- **Expanded**: Event title + venue + countdown + weather row + page dots

### Tile 2 Grid (6 Links)
Each cell in the 2×3 `LazyVGrid` is wrapped in `Link(destination: URL(...))` pointing to its individual deep link. This is the critical requirement: 6 independent tap targets.

### Lifecycle
1. App opens → `useLiveSurface` fetches payload from edge function
2. `updateLiveActivity()` called via native module bridge
3. If no activity exists → `Activity.request()` starts one with `.token` push type
4. If activity exists → `activity.update()` with new ContentState
5. On meaningful content change → push update via APNs token
6. No background polling — updates on app open + push only

## Android Architecture

### Ongoing Notification
- **Channel**: `dvnt_live_surface` (IMPORTANCE_LOW, no badge)
- **Notification ID**: 9001 (stable for updates)
- **RemoteViews**: Custom layouts for collapsed + expanded states

### Files Generated by Config Plugin
- `notification_live_surface.xml` — Collapsed layout (title + subtitle + dots)
- `notification_live_surface_expanded.xml` — Expanded layout with 2×3 grid
- `LiveSurfaceReceiver.kt` — BroadcastReceiver for Prev/Next/Dismiss actions
- `DVNTLiveNotificationModule.kt` — Native module for RN bridge
- `DVNTLiveNotificationPackage.kt` — ReactPackage registration

### 6 Independent PendingIntents (Tile 2)
Each `ImageView` in the expanded grid has `setOnClickPendingIntent` with `ACTION_VIEW` intent pointing to the cell's deep link URL. Request codes 100–105 ensure unique intents.

### Tile Navigation
- Prev/Next notification actions switch between tiles
- Current tile index persisted in SharedPreferences
- Notification refreshed on tile change via `LiveSurfaceReceiver`

### No Foreground Service
The notification is posted via `NotificationManager.notify()` with `setOngoing(true)`. No foreground service is needed.

## Backend (Edge Function)

### Endpoint
```
POST https://npfjanxturvmjyevoyfo.supabase.co/functions/v1/live-surface
Authorization: Bearer <better-auth-session-token>
```

### Deploy
```bash
npx supabase functions deploy live-surface --no-verify-jwt --project-ref npfjanxturvmjyevoyfo
```

### Caching
- Payload cached in `kv_cache` table (key: `live_surface_{authId}`)
- Cache TTL: 5 minutes (recompute at most once per 5 min)
- All 3 tiles built in parallel (`Promise.all`)

### Rate Limits
- Tile 2: recalculated max 1–2×/day (7-day window is inherently slow-changing)
- Tile 3: hourly max (events list changes infrequently)
- Tile 1: on event change (nearest upcoming shifts)
- Server-side 5-min cache prevents client hammering

### Payload Size
- ~1–2 KB typical (text only, thumb URLs are CDN paths)
- No inline images — only URL references

## Verification Checklist

- [ ] Tap Tile 1 → opens event detail (or create event if no events)
- [ ] Tap each of 6 Tile 2 cells → opens correct post detail
- [ ] Placeholder cells → navigate to weekly recap
- [ ] Tap Tile 3 cards → opens event detail
- [ ] "See all" → opens events list sorted soonest
- [ ] Missing thumb URLs → placeholder renders (no crash)
- [ ] Dynamic Island compact → shows logo + countdown
- [ ] Dynamic Island expanded → shows event + weather + dots
- [ ] Android notification Prev/Next → cycles tiles
- [ ] Android expanded grid → 6 tappable cells with correct deep links
- [ ] App resume → payload refreshed (no polling)
- [ ] Small screens + Dynamic Type → no layout overflow
- [ ] Battery: no background polling, no foreground service

## Build Requirements

### iOS
- Requires **new native build** (Widget Extension is a new target)
- Provisioning profile needed for `com.dvnt.app.live-activity` bundle ID
- App Group capability must be enabled in Apple Developer Portal
- After build: OTA updates can change the RN hook behavior, but Swift UI changes require a new build

### Android
- Requires **new native build** (new Kotlin files + layouts)
- No special signing or capabilities needed
- FCM data messages can update the notification payload
